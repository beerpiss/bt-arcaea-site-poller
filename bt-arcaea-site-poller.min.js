!function(){"use strict";console.log("BTIMPORT");const e="prod",t={staging:{baseUrl:"https://staging.bokutachi.xyz",clientId:"CI13c6fecdc2525d4fd6ee9b6d0552eecb00cc3d9e"},prod:{baseUrl:"https://bokutachi.xyz",clientId:"CI5d804b5eb97804476729fe30644878586b5e570d"}},o=t[e].baseUrl,n=t[e].clientId,r="api-key",i=["Past","Present","Future","Beyond"],c=["LOST","CLEAR","FULL RECALL","PURE MEMORY","EASY CLEAR","HARD CLEAR"];let a=!1;function s(t){return localStorage.getItem(`__btimport__${t}_${e}`)}function l(){window.open(`${o}/client-file-flow/${n}`);document.querySelector(".box-content").insertAdjacentHTML("afterend",'\n    <div id="api-key-setup" style="background-color: #fff">\n        <form id="api-key-form">\n            <input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>\n            <input type="submit" value="Save">\n        </form>\n    </div>\n    '),document.querySelector("#api-key-setup").addEventListener("submit",d)}function d(t){t.preventDefault();const o=document.querySelector("#api-key-form-key").value;var n,i;n=r,i=o,localStorage.setItem(`__btimport__${n}_${e}`,i.toString()),location.reload()}function p(){const e=document.querySelector(".box-content"),t=!!s(r),o=document.createElement("p");t||(o.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),o.append(document.createElement("br")));let n=t?"Reconfigure API key (if broken)":"Set up API key";const i=document.createElement("a");i.id="setup-api-key-onclick",i.append(document.createTextNode(n)),i.onclick=l,o.append(i);const c=document.createElement("div");if(c.append(o),c.style="\n        color: white;\n        width: 100%;\n        background-color: rgba(51, 50, 62, .75);\n        text-align: center;\n    ",t){const e=document.createElement("a");e.id="bt-poll-button",e.onclick=u,e.innerText="Start polling",c.append(e)}c.id="bt-import",e.append(c)}async function u(){a=!0;const e=document.querySelector("#bt-poll-button");for(e.innerText="Stop polling",e.onclick=()=>{m("Stopped polling."),e.onclick=u,e.innerText="Start polling",a=!1};a;){const e=(await(await fetch("https://webapi.lowiro.com/webapi/user/me")).json()).value;console.log(e),await y(e.recent_score[0]),await new Promise((e=>setTimeout(e,9e4)))}}function m(e){let t=document.querySelector("#bt-import"),o=document.querySelector("#bt-import-status");o||(o=document.createElement("p"),o.id="bt-import-status",t.append(o)),o.innerText=e}async function f(e,t){const o=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${s(r)}`}}),n=await o.json();if(n.success){if("ongoing"===n.body.importStatus)return m("Importing scores... "+n.description+" Progress: "+n.body.progress.description),void setTimeout(f,1e3,e);if("completed"!==n.body.importStatus)m(n.description);else{console.log(n.body);let e=`${n.description}\n        - Song ID: ${t.identifier}\n        - Score: ${t.score}\n        - Lamp: ${t.lamp}\n        - Judgements: ${t.judgements.pure}-${t.judgements.far}-${t.judgements.lost}\n        - Time played: ${new Date(t.timeAchieved).toString()}\n        `;if(n.body.import.errors.length>0){e+=`, ${n.body.import.errors.length} errors (see console log for details)`;for(const e of n.body.import.errors)console.log(`${e.type}: ${e.message}`)}m(e)}}else m("Terminal Error: "+n.description)}async function y(e){console.log(e);const{song_id:t,difficulty:n,score:a,shiny_perfect_count:l,perfect_count:d,near_count:p,miss_count:u,clear_type:y,best_clear_type:g,health:b,time_played:h,modifier:S}=e,k={identifier:t,matchType:"inGameStrID",difficulty:i[n],score:a,lamp:c[y],judgements:{pure:d,far:p,lost:u},timeAchieved:h};console.log(k),async function(e){const{scores:t=[]}=e,n={meta:{game:"arcaea",playtype:"Touch",service:"bt-arcaea-site-poller"},scores:t};if(0===t.length)return void m("Nothing to import.");const i=fetch(`${o}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+s(r),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(n)});m("Submitting scores..."),f((await(await i).json()).body.url,t[0])}({scores:[k]})}"undefined"!=typeof GM_fetch&&(fetch=GM_fetch),console.log("running");let g=document.querySelector(".banner.castle-banner");if(null===g){const b=document.getElementById("app"),h={childList:!0};function S(e,t){t.disconnect();for(const t of e)if("childList"===t.type&&null!==g)switch(location.pathname){case"/en/profile/":case"/jp/profile/":p()}}new MutationObserver(S).observe(b,h)}}();
