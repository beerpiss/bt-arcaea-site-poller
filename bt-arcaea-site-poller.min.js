!function(){"use strict";console.log("BTIMPORT");const e="staging",t={staging:{baseUrl:"https://staging.bokutachi.xyz",clientId:"CI13c6fecdc2525d4fd6ee9b6d0552eecb00cc3d9e"},prod:{baseUrl:"https://bokutachi.xyz",clientId:"CI5d804b5eb97804476729fe30644878586b5e570d"}},o=t[e].baseUrl,n=t[e].clientId,c="api-key",i=["Past","Present","Future","Beyond"],r=["LOST","CLEAR","FULL RECALL","PURE MEMORY","EASY CLEAR","HARD CLEAR"];let s=Date.now(),a=!1;function l(t){return localStorage.getItem(`__btimport__${t}_${e}`)}function p(){window.open(`${o}/client-file-flow/${n}`);document.querySelector(".box-content").insertAdjacentHTML("afterend",'\n    <div id="api-key-setup" style="background-color: #fff">\n        <form id="api-key-form">\n            <input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>\n            <input type="submit" value="Save">\n        </form>\n    </div>\n    '),document.querySelector("#api-key-setup").addEventListener("submit",d)}function d(t){t.preventDefault();const o=document.querySelector("#api-key-form-key").value;var n,i;n=c,i=o,localStorage.setItem(`__btimport__${n}_${e}`,i.toString()),location.reload()}function u(){const e=document.querySelector(".box-content"),t=!!l(c),o=document.createElement("p");t||(o.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),o.append(document.createElement("br")));let n=t?"Reconfigure API key (if broken)":"Set up API key";const i=document.createElement("a");i.id="setup-api-key-onclick",i.append(document.createTextNode(n)),i.onclick=p,o.append(i);const r=document.createElement("div");if(r.append(o),r.style="\n        color: white;\n        width: 100%;\n        background-color: rgba(51, 50, 62, .75);\n        text-align: center;\n    ",t){const e=document.createElement("a");e.id="bt-poll-button",e.onclick=m,e.innerText="- Start polling",r.append(e),r.append(document.createElement("br"));const t=document.createElement("a");t.id="bt-b30-button",t.onclick=h,t.innerText="- (REQUIRES ARCAEA ONLINE SUBSCRIPTION) Import best 30 scores",r.append(t)}r.id="bt-import",e.append(r)}async function m(){a=!0;const e=document.querySelector("#bt-poll-button");for(e.innerText="- Stop polling",e.onclick=()=>{f("Stopped polling."),e.onclick=m,e.innerText="Start polling",a=!1};a;){if(Date.now()-s==9e5){f("Script timed out. Stopped polling."),e.onclick=m,e.innerText="Start polling",a=!1;break}const t=(await(await fetch("https://webapi.lowiro.com/webapi/user/me")).json()).value;console.log(t),await g(t.recent_score[0]),await new Promise((e=>setTimeout(e,9e4)))}}function f(e){let t=document.querySelector("#bt-import"),o=document.querySelector("#bt-import-status");o||(o=document.createElement("p"),o.id="bt-import-status",t.append(o)),o.innerText=e}async function y(e){const{scores:t=[]}=e,n={meta:{game:"arcaea",playtype:"Touch",service:"bt-arcaea-site-poller"},scores:t};if(0===t.length)return void f("Nothing to import.");const i=fetch(`${o}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+l(c),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(n)});f("Submitting scores...");b((await(await i).json()).body.url,t)}async function b(e,t){const o=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${l(c)}`}}),n=await o.json();if(n.success){if("ongoing"===n.body.importStatus)return f("Importing scores... "+n.description+" Progress: "+n.body.progress.description),void setTimeout(b,1e3,e);if("completed"!==n.body.importStatus)f(n.description);else{let e;if(console.log(n.body),1===t.length){let o=t[0];e=`${n.description}\n            - Song ID: ${o.identifier}\n            - Score: ${o.score}\n            - Lamp: ${o.lamp}\n            - Judgements: ${o.judgements.pure}-${o.judgements.far}-${o.judgements.lost}\n            - Time played: ${new Date(o.timeAchieved).toString()}\n            `}else e=`${n.description} ${n.body.import.scoreIDs.length} scores.`;if(n.body.import.errors.length>0){e+=`, ${n.body.import.errors.length} errors (see console log for details)`;for(const e of n.body.import.errors)console.log(`${e.type}: ${e.message}`)}f(e)}}else f("Terminal Error: "+n.description)}async function g(e){console.log(e);const{song_id:t,difficulty:o,score:n,shiny_perfect_count:c,perfect_count:a,near_count:l,miss_count:p,clear_type:d,best_clear_type:u,health:m,time_played:f,modifier:b}=e,g={identifier:t,matchType:"inGameStrID",difficulty:i[o],score:n,lamp:r[d],judgements:{pure:a,far:l,lost:p},timeAchieved:f};f>s&&(s=f,console.log(g),y({scores:[g]}))}async function h(e){console.log(e);let t=[];for(const o of e){const{song_id:e,difficulty:n,score:c,shiny_perfect_count:s,perfect_count:a,near_count:l,miss_count:p,clear_type:d,best_clear_type:u,health:m,time_played:f,modifier:y}=o,b={identifier:e,matchType:"inGameStrID",difficulty:i[n],score:c,lamp:r[d],judgements:{pure:a,far:l,lost:p},timeAchieved:f};t.push(b)}y({scores:t})}"undefined"!=typeof GM_fetch&&(fetch=GM_fetch),console.log("running");let S=document.querySelector(".banner.castle-banner");if(null===S){const _=document.getElementById("app"),k={childList:!0};function I(e,t){t.disconnect();for(const t of e)if("childList"===t.type&&(S=document.querySelector(".banner.castle-banner"),null!==S))switch(location.pathname){case"/en/profile/":case"/jp/profile/":u()}}new MutationObserver(I).observe(_,k)}else switch(location.pathname){case"/en/profile/":case"/jp/profile/":u()}}();
