!function(){"use strict";console.log("BTIMPORT");const e="prod",t={staging:{baseUrl:"https://staging.bokutachi.xyz",clientId:"CI13c6fecdc2525d4fd6ee9b6d0552eecb00cc3d9e"},prod:{baseUrl:"https://bokutachi.xyz",clientId:"CI5d804b5eb97804476729fe30644878586b5e570d"}},o=t[e].baseUrl,n=t[e].clientId,i="api-key",r=["Past","Present","Future","Beyond"],c=["LOST","CLEAR","FULL RECALL","PURE MEMORY","EASY CLEAR","HARD CLEAR"];let a=Date.now(),s=!1;function l(t){return localStorage.getItem(`__btimport__${t}_${e}`)}function p(){window.open(`${o}/client-file-flow/${n}`);document.querySelector(".box-content").insertAdjacentHTML("afterend",'\n    <div id="api-key-setup" style="background-color: #fff">\n        <form id="api-key-form">\n            <input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>\n            <input type="submit" value="Save">\n        </form>\n    </div>\n    '),document.querySelector("#api-key-setup").addEventListener("submit",d)}function d(t){t.preventDefault();const o=document.querySelector("#api-key-form-key").value;var n,r;n=i,r=o,localStorage.setItem(`__btimport__${n}_${e}`,r.toString()),location.reload()}function u(){const e=document.querySelector(".box-content"),t=!!l(i),o=document.createElement("p");t||(o.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),o.append(document.createElement("br")));let n=t?"Reconfigure API key (if broken)":"Set up API key";const r=document.createElement("a");r.id="setup-api-key-onclick",r.append(document.createTextNode(n)),r.onclick=p,o.append(r);const c=document.createElement("div");if(c.append(o),c.style="\n        color: white;\n        width: 100%;\n        background-color: rgba(51, 50, 62, .75);\n        text-align: center;\n    ",t){const e=document.createElement("a");e.id="bt-poll-button",e.onclick=m,e.innerText="Start polling",c.append(e)}c.id="bt-import",e.append(c)}async function m(){s=!0;const e=document.querySelector("#bt-poll-button");for(e.innerText="Stop polling",e.onclick=()=>{f("Stopped polling."),e.onclick=m,e.innerText="Start polling",s=!1};s;){if(Date.now()-a==9e5){f("Script timed out. Stopped polling."),e.onclick=m,e.innerText="Start polling",s=!1;break}const t=(await(await fetch("https://webapi.lowiro.com/webapi/user/me")).json()).value;console.log(t),await g(t.recent_score[0]),await new Promise((e=>setTimeout(e,9e4)))}}function f(e){let t=document.querySelector("#bt-import"),o=document.querySelector("#bt-import-status");o||(o=document.createElement("p"),o.id="bt-import-status",t.append(o)),o.innerText=e}async function y(e,t){const o=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${l(i)}`}}),n=await o.json();if(n.success){if("ongoing"===n.body.importStatus)return f("Importing scores... "+n.description+" Progress: "+n.body.progress.description),void setTimeout(y,1e3,e);if("completed"!==n.body.importStatus)f(n.description);else{console.log(n.body);let e=`${n.description}\n        - Song ID: ${t.identifier}\n        - Score: ${t.score}\n        - Lamp: ${t.lamp}\n        - Judgements: ${t.judgements.pure}-${t.judgements.far}-${t.judgements.lost}\n        - Time played: ${new Date(t.timeAchieved).toString()}\n        `;if(n.body.import.errors.length>0){e+=`, ${n.body.import.errors.length} errors (see console log for details)`;for(const e of n.body.import.errors)console.log(`${e.type}: ${e.message}`)}f(e)}}else f("Terminal Error: "+n.description)}async function g(e){console.log(e);const{song_id:t,difficulty:n,score:s,shiny_perfect_count:p,perfect_count:d,near_count:u,miss_count:m,clear_type:g,best_clear_type:b,health:h,time_played:S,modifier:k}=e,w={identifier:t,matchType:"inGameStrID",difficulty:r[n],score:s,lamp:c[g],judgements:{pure:d,far:u,lost:m},timeAchieved:S};S>a&&(a=S,console.log(w),async function(e){const{scores:t=[]}=e,n={meta:{game:"arcaea",playtype:"Touch",service:"bt-arcaea-site-poller"},scores:t};if(0===t.length)return void f("Nothing to import.");const r=fetch(`${o}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+l(i),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(n)});f("Submitting scores..."),y((await(await r).json()).body.url,t[0])}({scores:[w]}))}"undefined"!=typeof GM_fetch&&(fetch=GM_fetch),console.log("running");let b=document.querySelector(".banner.castle-banner");if(null===b){const h=document.getElementById("app"),S={childList:!0};function k(e,t){t.disconnect();for(const t of e)if("childList"===t.type&&null!==b)switch(location.pathname){case"/en/profile/":case"/jp/profile/":u()}}new MutationObserver(k).observe(h,S)}else switch(location.pathname){case"/en/profile/":case"/jp/profile/":u()}}();
